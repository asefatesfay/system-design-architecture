openapi: 3.0.0

info:
  title: Proximity Service API
  version: 1.0.0
  description: |
    REST API for finding nearby places based on geographic location.
    
    ## Features
    - Search for places within a specified radius
    - Filter by place type (restaurant, cafe, hotel, etc.)
    - Add, update, and delete places
    - Get detailed place information
    - Support for pagination and sorting
    
    ## Rate Limiting
    - 1000 requests per hour per API key
    - 5000 requests per hour for premium users
    
    ## Authentication
    Write operations (POST, PUT, DELETE) require authentication using JWT tokens.
    
  contact:
    name: API Support
    email: api-support@proximity.example.com
    url: https://proximity.example.com/support
  
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: https://api.proximity.example.com/v1
    description: Production server
  - url: https://api-staging.proximity.example.com/v1
    description: Staging server
  - url: http://localhost:8080/v1
    description: Local development server

tags:
  - name: Search
    description: Search for nearby places
  - name: Places
    description: CRUD operations for places
  - name: Photos
    description: Photo upload and management for places
  - name: Health
    description: Health check endpoints

paths:
  /places/nearby:
    get:
      tags:
        - Search
      summary: Search nearby places
      description: |
        Find places within a specified radius of a given location.
        Results are sorted by distance (closest first).
      operationId: searchNearbyPlaces
      parameters:
        - name: latitude
          in: query
          required: true
          description: Latitude of the search center point
          schema:
            type: number
            format: double
            minimum: -90
            maximum: 90
          example: 37.7749
        
        - name: longitude
          in: query
          required: true
          description: Longitude of the search center point
          schema:
            type: number
            format: double
            minimum: -180
            maximum: 180
          example: -122.4194
        
        - name: radius
          in: query
          required: false
          description: Search radius in meters
          schema:
            type: integer
            minimum: 100
            maximum: 50000
            default: 5000
          example: 5000
        
        - name: type
          in: query
          required: false
          description: Filter by place type
          schema:
            type: string
            enum:
              - restaurant
              - cafe
              - hotel
              - gas_station
              - hospital
              - pharmacy
              - bank
              - atm
              - parking
              - shopping_mall
              - gym
              - museum
              - park
          example: restaurant
        
        - name: limit
          in: query
          required: false
          description: Maximum number of results to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
        
        - name: offset
          in: query
          required: false
          description: Number of results to skip (for pagination)
          schema:
            type: integer
            minimum: 0
            default: 0
          example: 0
        
        - name: open_now
          in: query
          required: false
          description: Filter to only show places currently open
          schema:
            type: boolean
          example: true
        
        - name: min_rating
          in: query
          required: false
          description: Minimum rating (0-5)
          schema:
            type: number
            format: float
            minimum: 0
            maximum: 5
          example: 4.0
      
      responses:
        '200':
          description: Successful response with list of nearby places
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NearbyPlacesResponse'
              examples:
                success:
                  summary: Example response
                  value:
                    places:
                      - place_id: "chIJN1t_tDeuEmsRUsoyG83frY4"
                        name: "Blue Bottle Coffee"
                        address: "66 Mint St, San Francisco, CA 94103"
                        location:
                          latitude: 37.7764
                          longitude: -122.4172
                        distance: 450
                        rating: 4.5
                        type: "cafe"
                        is_open: true
                      - place_id: "chIJPZDrEzeuEmsRwMRrY83frB2"
                        name: "Foreign Cinema"
                        address: "2534 Mission St, San Francisco, CA 94110"
                        location:
                          latitude: 37.7584
                          longitude: -122.4188
                        distance: 1850
                        rating: 4.3
                        type: "restaurant"
                        is_open: false
                    total: 156
                    has_more: true
        
        '400':
          $ref: '#/components/responses/BadRequest'
        
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        
        '500':
          $ref: '#/components/responses/InternalServerError'

  /places/search-area:
    post:
      tags:
        - Search
      summary: Search places within a polygon area
      description: Find places within a defined polygon boundary
      operationId: searchPlacesByArea
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AreaSearchRequest'
            example:
              polygon:
                - latitude: 37.7749
                  longitude: -122.4194
                - latitude: 37.7849
                  longitude: -122.4094
                - latitude: 37.7649
                  longitude: -122.4094
              type: "restaurant"
              limit: 50
      
      responses:
        '200':
          description: Places found within the area
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NearbyPlacesResponse'
        
        '400':
          $ref: '#/components/responses/BadRequest'
        
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  /places/{place_id}:
    get:
      tags:
        - Places
      summary: Get place details
      description: Retrieve detailed information about a specific place
      operationId: getPlaceById
      parameters:
        - name: place_id
          in: path
          required: true
          description: Unique identifier for the place
          schema:
            type: string
          example: "chIJN1t_tDeuEmsRUsoyG83frY4"
      
      responses:
        '200':
          description: Place details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaceDetails'
              example:
                place_id: "chIJN1t_tDeuEmsRUsoyG83frY4"
                name: "Blue Bottle Coffee"
                address: "66 Mint St, San Francisco, CA 94103"
                location:
                  latitude: 37.7764
                  longitude: -122.4172
                phone: "+1 415-495-3394"
                website: "https://bluebottlecoffee.com"
                rating: 4.5
                type: "cafe"
                hours:
                  monday: "07:00-19:00"
                  tuesday: "07:00-19:00"
                  wednesday: "07:00-19:00"
                  thursday: "07:00-19:00"
                  friday: "07:00-19:00"
                  saturday: "08:00-18:00"
                  sunday: "08:00-18:00"
                photos:
                  - "https://cdn.example.com/photos/abc123.jpg"
                  - "https://cdn.example.com/photos/def456.jpg"
                created_at: "2020-05-15T10:30:00Z"
                updated_at: "2026-02-01T14:20:00Z"
        
        '404':
          $ref: '#/components/responses/NotFound'
        
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    put:
      tags:
        - Places
      summary: Update place
      description: Update information for an existing place (requires authentication)
      operationId: updatePlace
      security:
        - BearerAuth: []
      parameters:
        - name: place_id
          in: path
          required: true
          description: Unique identifier for the place
          schema:
            type: string
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePlaceRequest'
            example:
              name: "New Cafe - Updated"
              hours:
                monday: "07:00-21:00"
      
      responses:
        '200':
          description: Place updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdatePlaceResponse'
              example:
                place_id: "chIJXYZ123newPlaceId"
                message: "Place updated successfully"
                updated_at: "2026-02-08T15:30:00Z"
        
        '400':
          $ref: '#/components/responses/BadRequest'
        
        '401':
          $ref: '#/components/responses/Unauthorized'
        
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags:
        - Places
      summary: Delete place
      description: Delete a place (requires authentication)
      operationId: deletePlace
      security:
        - BearerAuth: []
      parameters:
        - name: place_id
          in: path
          required: true
          schema:
            type: string
      
      responses:
        '204':
          description: Place deleted successfully
        
        '401':
          $ref: '#/components/responses/Unauthorized'
        
        '404':
          $ref: '#/components/responses/NotFound'

  /places:
    post:
      tags:
        - Places
      summary: Add a new place
      description: Create a new place entry (requires authentication)
      operationId: createPlace
      security:
        - BearerAuth: []
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePlaceRequest'
            example:
              name: "New Cafe"
              address: "123 Main St, San Francisco, CA 94102"
              location:
                latitude: 37.7850
                longitude: -122.4100
              phone: "+1 415-555-0123"
              website: "https://newcafe.com"
              type: "cafe"
              hours:
                monday: "08:00-20:00"
                tuesday: "08:00-20:00"
                wednesday: "08:00-20:00"
                thursday: "08:00-20:00"
                friday: "08:00-20:00"
                saturday: "09:00-21:00"
                sunday: "09:00-21:00"
      
      responses:
        '201':
          description: Place created successfully
          headers:
            Location:
              description: URL of the created place
              schema:
                type: string
              example: "/v1/places/chIJXYZ123newPlaceId"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePlaceResponse'
              example:
                place_id: "chIJXYZ123newPlaceId"
                message: "Place created successfully"
                created_at: "2026-02-08T12:00:00Z"
        
        '400':
          $ref: '#/components/responses/BadRequest'
        
        '401':
          $ref: '#/components/responses/Unauthorized'
        
        '409':
          description: Place already exists at this location
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "DUPLICATE_PLACE"
                message: "A place already exists at this location"

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check if the service is healthy
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time
                    example: "2026-02-08T12:00:00Z"
                  version:
                    type: string
                    example: "1.0.0"

  /places/{place_id}/photos/upload-url:
    post:
      tags:
        - Photos
      summary: Request photo upload URL
      description: |
        Request a pre-signed S3 URL for uploading a photo directly to storage.
        This endpoint returns a temporary URL that allows the client to upload
        photos directly to S3 without going through the API server.
      operationId: requestPhotoUploadUrl
      security:
        - BearerAuth: []
      parameters:
        - name: place_id
          in: path
          required: true
          description: Unique identifier for the place
          schema:
            type: string
          example: "place_123"
        - name: filename
          in: query
          required: true
          description: Original filename of the photo
          schema:
            type: string
          example: "photo.jpg"
        - name: content_type
          in: query
          required: true
          description: MIME type of the photo
          schema:
            type: string
            enum:
              - image/jpeg
              - image/png
              - image/webp
          example: "image/jpeg"
      
      responses:
        '200':
          description: Upload URL generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  photo_id:
                    type: string
                    description: Unique identifier for the photo
                    example: "photo_abc123"
                  upload_url:
                    type: string
                    description: Pre-signed S3 URL for direct upload
                    example: "https://proximity-photos.s3.amazonaws.com/photos/place_123/original/abc123.jpg?X-Amz-..."
                  expires_at:
                    type: string
                    format: date-time
                    description: When the upload URL expires (typically 15 minutes)
                    example: "2026-02-10T12:15:00Z"
                  method:
                    type: string
                    description: HTTP method to use for upload
                    example: "PUT"
                  headers:
                    type: object
                    description: Required headers for the upload request
                    properties:
                      Content-Type:
                        type: string
                        example: "image/jpeg"
        
        '400':
          $ref: '#/components/responses/BadRequest'
        
        '401':
          $ref: '#/components/responses/Unauthorized'
        
        '403':
          description: Not authorized to upload photos for this place
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "FORBIDDEN"
                message: "You don't have permission to upload photos for this place"

  /photos/{photo_id}/complete:
    post:
      tags:
        - Photos
      summary: Confirm photo upload
      description: |
        Confirm that a photo has been successfully uploaded to S3 and trigger
        the image processing pipeline (resize, optimization, thumbnail generation).
      operationId: confirmPhotoUpload
      security:
        - BearerAuth: []
      parameters:
        - name: photo_id
          in: path
          required: true
          description: Unique identifier for the photo
          schema:
            type: string
          example: "photo_abc123"
      
      responses:
        '200':
          description: Upload confirmed and processing started
          content:
            application/json:
              schema:
                type: object
                properties:
                  photo_id:
                    type: string
                    example: "photo_abc123"
                  status:
                    type: string
                    enum:
                      - processing
                      - ready
                      - failed
                    example: "processing"
                  message:
                    type: string
                    example: "Photo is being processed. Check back in a few seconds."
        
        '400':
          description: Invalid photo ID or photo already confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "INVALID_STATE"
                message: "Photo already confirmed or file not found in S3"
        
        '401':
          $ref: '#/components/responses/Unauthorized'
        
        '404':
          $ref: '#/components/responses/NotFound'

  /places/{place_id}/photos:
    get:
      tags:
        - Photos
      summary: Get place photos
      description: Retrieve all photos for a specific place
      operationId: getPlacePhotos
      parameters:
        - name: place_id
          in: path
          required: true
          description: Unique identifier for the place
          schema:
            type: string
          example: "place_123"
      
      responses:
        '200':
          description: Photos retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  photos:
                    type: array
                    items:
                      $ref: '#/components/schemas/Photo'
                  total:
                    type: integer
                    example: 5
              example:
                photos:
                  - photo_id: "photo_001"
                    thumb_url: "https://cdn.proximity.example.com/photos/place_123/thumb/abc.webp"
                    medium_url: "https://cdn.proximity.example.com/photos/place_123/medium/abc.webp"
                    large_url: "https://cdn.proximity.example.com/photos/place_123/large/abc.webp"
                    is_primary: true
                    uploaded_by: "user_123"
                    uploaded_at: "2026-02-01T10:30:00Z"
                total: 5
        
        '404':
          $ref: '#/components/responses/NotFound'

  /photos/{photo_id}:
    delete:
      tags:
        - Photos
      summary: Delete photo
      description: Delete a photo from a place (requires authentication)
      operationId: deletePhoto
      security:
        - BearerAuth: []
      parameters:
        - name: photo_id
          in: path
          required: true
          description: Unique identifier for the photo
          schema:
            type: string
          example: "photo_abc123"
      
      responses:
        '204':
          description: Photo deleted successfully
        
        '401':
          $ref: '#/components/responses/Unauthorized'
        
        '403':
          description: Not authorized to delete this photo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "FORBIDDEN"
                message: "You don't have permission to delete this photo"
        
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token authentication. Include the token in the Authorization header:
        `Authorization: Bearer <token>`

  schemas:
    Location:
      type: object
      required:
        - latitude
        - longitude
      properties:
        latitude:
          type: number
          format: double
          minimum: -90
          maximum: 90
          description: Latitude coordinate
          example: 37.7749
        longitude:
          type: number
          format: double
          minimum: -180
          maximum: 180
          description: Longitude coordinate
          example: -122.4194
    
    PlaceSummary:
      type: object
      required:
        - place_id
        - name
        - address
        - location
        - type
      properties:
        place_id:
          type: string
          description: Unique identifier for the place
          example: "chIJN1t_tDeuEmsRUsoyG83frY4"
        name:
          type: string
          description: Name of the place
          example: "Blue Bottle Coffee"
        address:
          type: string
          description: Full address
          example: "66 Mint St, San Francisco, CA 94103"
        location:
          $ref: '#/components/schemas/Location'
        distance:
          type: number
          format: float
          description: Distance from search point in meters
          example: 450.5
        rating:
          type: number
          format: float
          minimum: 0
          maximum: 5
          description: Average rating (0-5)
          example: 4.5
        type:
          type: string
          description: Type of place
          example: "cafe"
        is_open:
          type: boolean
          description: Whether the place is currently open
          example: true
    
    PlaceDetails:
      allOf:
        - $ref: '#/components/schemas/PlaceSummary'
        - type: object
          properties:
            phone:
              type: string
              description: Phone number
              example: "+1 415-495-3394"
            website:
              type: string
              format: uri
              description: Website URL
              example: "https://bluebottlecoffee.com"
            hours:
              type: object
              description: Business hours for each day
              additionalProperties:
                type: string
              example:
                monday: "07:00-19:00"
                tuesday: "07:00-19:00"
                wednesday: "07:00-19:00"
                thursday: "07:00-19:00"
                friday: "07:00-19:00"
                saturday: "08:00-18:00"
                sunday: "08:00-18:00"
            photos:
              type: array
              description: URLs of place photos
              items:
                type: string
                format: uri
              example:
                - "https://cdn.example.com/photos/abc123.jpg"
                - "https://cdn.example.com/photos/def456.jpg"
            created_at:
              type: string
              format: date-time
              description: When the place was added
              example: "2020-05-15T10:30:00Z"
            updated_at:
              type: string
              format: date-time
              description: When the place was last updated
              example: "2026-02-01T14:20:00Z"
    
    NearbyPlacesResponse:
      type: object
      required:
        - places
        - total
        - has_more
      properties:
        places:
          type: array
          items:
            $ref: '#/components/schemas/PlaceSummary'
        total:
          type: integer
          description: Total number of places matching the search
          example: 156
        has_more:
          type: boolean
          description: Whether more results are available
          example: true
    
    CreatePlaceRequest:
      type: object
      required:
        - name
        - address
        - location
        - type
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Name of the place
          example: "New Cafe"
        address:
          type: string
          minLength: 1
          maxLength: 500
          description: Full address
          example: "123 Main St, San Francisco, CA 94102"
        location:
          $ref: '#/components/schemas/Location'
        phone:
          type: string
          pattern: '^\+?[1-9]\d{1,14}$'
          description: Phone number in E.164 format
          example: "+14155550123"
        website:
          type: string
          format: uri
          maxLength: 500
          description: Website URL
          example: "https://newcafe.com"
        type:
          type: string
          description: Type of place
          example: "cafe"
        hours:
          type: object
          description: Business hours
          additionalProperties:
            type: string
          example:
            monday: "08:00-20:00"
            tuesday: "08:00-20:00"
    
    UpdatePlaceRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        address:
          type: string
          minLength: 1
          maxLength: 500
        phone:
          type: string
          pattern: '^\+?[1-9]\d{1,14}$'
        website:
          type: string
          format: uri
          maxLength: 500
        hours:
          type: object
          additionalProperties:
            type: string
    
    CreatePlaceResponse:
      type: object
      required:
        - place_id
        - message
        - created_at
      properties:
        place_id:
          type: string
          description: ID of the created place
          example: "chIJXYZ123newPlaceId"
        message:
          type: string
          example: "Place created successfully"
        created_at:
          type: string
          format: date-time
          example: "2026-02-08T12:00:00Z"
    
    UpdatePlaceResponse:
      type: object
      required:
        - place_id
        - message
        - updated_at
      properties:
        place_id:
          type: string
          example: "chIJXYZ123newPlaceId"
        message:
          type: string
          example: "Place updated successfully"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-08T15:30:00Z"
    
    AreaSearchRequest:
      type: object
      required:
        - polygon
      properties:
        polygon:
          type: array
          minItems: 3
          maxItems: 100
          description: Array of coordinates defining the polygon boundary
          items:
            $ref: '#/components/schemas/Location'
        type:
          type: string
          description: Filter by place type
        limit:
          type: integer
          minimum: 1
          maximum: 100
          default: 50
    
    Photo:
      type: object
      required:
        - photo_id
        - thumb_url
        - medium_url
        - large_url
      properties:
        photo_id:
          type: string
          description: Unique identifier for the photo
          example: "photo_abc123"
        thumb_url:
          type: string
          format: uri
          description: URL for thumbnail version (150x150)
          example: "https://cdn.proximity.example.com/photos/place_123/thumb/abc.webp"
        medium_url:
          type: string
          format: uri
          description: URL for medium version (600x400)
          example: "https://cdn.proximity.example.com/photos/place_123/medium/abc.webp"
        large_url:
          type: string
          format: uri
          description: URL for large version (1200x800)
          example: "https://cdn.proximity.example.com/photos/place_123/large/abc.webp"
        is_primary:
          type: boolean
          description: Whether this is the primary photo for the place
          example: true
        uploaded_by:
          type: string
          description: User ID of the uploader
          example: "user_123"
        uploaded_at:
          type: string
          format: date-time
          description: Timestamp when the photo was uploaded
          example: "2026-02-01T10:30:00Z"
    
    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
          example: "INVALID_COORDINATES"
        message:
          type: string
          description: Human-readable error message
          example: "Latitude must be between -90 and 90"
        details:
          type: object
          description: Additional error details
          additionalProperties: true

  responses:
    BadRequest:
      description: Bad request - Invalid input parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            invalid_coordinates:
              summary: Invalid coordinates
              value:
                error: "INVALID_COORDINATES"
                message: "Latitude must be between -90 and 90"
            missing_parameter:
              summary: Missing required parameter
              value:
                error: "MISSING_PARAMETER"
                message: "Required parameter 'latitude' is missing"
    
    Unauthorized:
      description: Unauthorized - Invalid or missing authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "UNAUTHORIZED"
            message: "Authentication token is invalid or expired"
    
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "NOT_FOUND"
            message: "Place with ID 'abc123' not found"
    
    RateLimitExceeded:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          description: Maximum requests per hour
          schema:
            type: integer
          example: 1000
        X-RateLimit-Remaining:
          description: Remaining requests in current window
          schema:
            type: integer
          example: 0
        X-RateLimit-Reset:
          description: Unix timestamp when the rate limit resets
          schema:
            type: integer
          example: 1707393600
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "RATE_LIMIT_EXCEEDED"
            message: "Rate limit of 1000 requests per hour exceeded. Try again in 30 minutes."
    
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "INTERNAL_SERVER_ERROR"
            message: "An unexpected error occurred. Please try again later."

  parameters:
    PlaceId:
      name: place_id
      in: path
      required: true
      description: Unique identifier for a place
      schema:
        type: string
      example: "chIJN1t_tDeuEmsRUsoyG83frY4"

security: []
